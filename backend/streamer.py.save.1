import subprocess
import os
import time
import threading
import signal
from fastapi import FastAPI
import uvicorn

app = FastAPI()
proceso_ffmpeg = None

HLS_PATH = "/dev/shm/hls"
TITULO_FILE = os.path.join(HLS_PATH, "titulo.txt")
MEDIA_ROOT = "/media/HDD3TB/PELICULAS/movies/esdla/"
PLAYLIST_FILE = "/var/www/ridetogondor/backend/playlist.txt"

# --- LÓGICA DE STREAMING ---

def actualizar_titulo_desde_log(proceso):
    """Lee el log de FFmpeg para detectar qué archivo se está reproduciendo."""
    for line in iter(proceso.stderr.readline, b''):
        line_str = line.decode('utf-8', errors='ignore')
        if "Opening '" in line_str and MEDIA_ROOT in line_str:
            try:
                path = line_str.split("'")[1]
                nombre = os.path.basename(path).rsplit('.', 1)[0]
                with open(TITULO_FILE, "w") as f:
                    f.write(nombre)
            except: pass

def iniciar_ffmpeg():
    global proceso_ffmpeg
    comando = [
        'ffmpeg', '-re', '-stream_loop', '-1', '-f', 'concat', '-safe', '0', '-i', PLAYLIST_FILE,
        '-map', '0:v:0', '-map', '0:a:m:language:spa?',
        '-c:v', 'libx264', '-preset', 'veryfast', '-b:v', '3000k', '-maxrate', '3000k', '-bufsize', '6000k',
        '-pix_fmt', 'yuv420p', '-g', '50', '-c:a', 'aac', '-b:a', '128k', '-ac', '2',
        '-af', 'aresample=async=1', '-vsync', 'cfr',
        '-f', 'hls', '-hls_time', '4', '-hls_list_size', '5', '-hls_flags', 'delete_segments',
        os.path.join(HLS_PATH, 'live.m3u8')
    ]
    proceso_ffmpeg = subprocess.Popen(comando, stderr=subprocess.PIPE)
    return proceso_ffmpeg

# --- ENDPOINTS DE CONTROL ---

@app.get("/next")
async def next_movie():
    global proceso_ffmpeg
    if proceso_ffmpeg:
        # Enviamos señal de terminación a FFmpeg. 
        # Al morir, el bucle principal lo reiniciará saltando a la siguiente
        os.kill(proceso_ffmpeg.pid, signal.SIGTERM)
        return {"status": "Saltando a la siguiente película..."}
    return {"status": "FFmpeg no está en ejecución"}

# --- HILO PRINCIPAL ---

def run_stream():
    while True:
        proc = iniciar_ffmpeg()
        t = threading.Thread(target=actualizar_titulo_desde_log, args=(proc,))
        t.setDaemon(True)
        t.start()
        proc.wait()
        time.sleep(2) # Breve pausa antes de reiniciar

if __name__ == "__main__":
    # Lanzamos el streaming en un hilo separado
    threading.Thread(target=run_stream, daemon=True).start()
    # Arrancamos el servidor API en el puerto 8097
    uvicorn.run(app, host="127.0.0.1", port=8097)
