import subprocess
import os
import time

HLS_PATH = "/dev/shm/hls"
TITULO_FILE = os.path.join(HLS_PATH, "titulo.txt")
MEDIA_ROOT = "/media/HDD3TB/PELICULAS/movies/esdla/"
PLAYLIST_FILE = "/var/www/ridetogondor/backend/playlist.txt"

ORDEN_CARPETAS = [
    "La Comunidad del Anillo (2001) {edition-Version Extendida}",
    "Las Dos Torres (2002) {edition-Version Extendida}",
    "El Retorno del Rey (2003) {edition-Version Extendida}",
    "El Hobbit Un Viaje Inesperado (2012)",
    "El Hobbit 2 La Desolaci√≥n de Smaug (2013)",
    "El Hobbit La Batalla de los Cinco Ejercitos (2014)"
]

def generar_lista_y_titulos():
    if not os.path.exists(HLS_PATH):
        os.makedirs(HLS_PATH)
    with open(PLAYLIST_FILE, "w") as f:
        for carpeta in ORDEN_CARPETAS:
            ruta = os.path.join(MEDIA_ROOT, carpeta)
            if os.path.exists(ruta):
                videos = [v for v in os.listdir(ruta) if v.lower().endswith(('.mp4', '.mkv'))]
                for v in sorted(videos):
                    video_path = os.path.join(ruta, v)
                    f.write(f"file '{video_path.replace(chr(39), chr(39)+chr(92)+chr(39)+chr(39))}'\n")

def iniciar_ffmpeg():
    comando = [
        'ffmpeg', '-re', '-stream_loop', '-1', '-f', 'concat', '-safe', '0', '-i', PLAYLIST_FILE,
        '-map', '0:v:0', '-map', '0:a:m:language:spa?',
        '-c:v', 'libx264', '-preset', 'veryfast', '-b:v', '3000k', '-maxrate', '3000k', '-bufsize', '6000k',
        '-pix_fmt', 'yuv420p', '-g', '50', '-c:a', 'aac', '-b:a', '128k', '-ac', '2',
        '-af', 'aresample=async=1', '-vsync', 'cfr',
        '-f', 'hls', '-hls_time', '4', '-hls_list_size', '5', '-hls_flags', 'delete_segments',
        os.path.join(HLS_PATH, 'live.m3u8')
    ]
    return subprocess.Popen(comando)

if __name__ == "__main__":
    generar_lista_y_titulos()
    with open(TITULO_FILE, "w") as f:
        f.write("Ride to Gondor: La Marcha Comienza")
    
    while True:
        proceso = iniciar_ffmpeg()
        proceso.wait()
        time.sleep(5)
